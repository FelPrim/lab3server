import socket
import struct
import time
import select

def debug_test():
    """–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Å –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–º –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–º —á—Ç–µ–Ω–∏–µ–º"""
    print("=== –î–µ—Ç–∞–ª—å–Ω—ã–π —Ç–µ—Å—Ç ===")
    
    try:
        # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(10)
        sock.connect(('localhost', 23231))
        
        # –í–∫–ª—é—á–∞–µ–º TCP_NODELAY –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
        print("‚úì –£—Å–ø–µ—à–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º UDP-–∞–¥—Ä–µ—Å
        udp_payload = struct.pack('!HHI8s', 2, 12345, 0x7F000001, b'\x00' * 8)
        message = b'\x01' + udp_payload
        sock.send(message)
        print("‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω UDP-–∞–¥—Ä–µ—Å")
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–µ—Ä–≤–µ—Ä–æ–º
        time.sleep(0.1)
        
        # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∏–º–∞
        sock.send(b'\x03')
        print("‚úì –û—Ç–ø—Ä–∞–≤–ª–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä–∏–º–∞")
        
        # –ñ–¥–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å –∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω—ã–º –Ω–µ–±–ª–æ–∫–∏—Ä—É—é—â–∏–º —á—Ç–µ–Ω–∏–µ–º
        print("–ñ–¥–µ–º –æ—Ç–≤–µ—Ç...")
        start_time = time.time()
        while time.time() - start_time < 5:
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º select –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (–∫—Ä–æ—Å—Å–ø–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ)
            ready = select.select([sock], [], [], 0.1)
            if ready[0]:
                data = sock.recv(1024)
                if data:
                    print(f"‚úì –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ! –î–ª–∏–Ω–∞: {len(data)} –±–∞–π—Ç")
                    print(f"  –®–µ—Å—Ç–Ω–∞–¥—Ü–∞—Ç–µ—Ä–∏—á–Ω—ã–π –≤–∏–¥: {data.hex()}")
                    
                    if len(data) >= 1:
                        msg_type = data[0]
                        print(f"  –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è: 0x{msg_type:02x}")
                        
                        if len(data) >= 5 and msg_type == 0x81:
                            stream_id = struct.unpack('!I', data[1:5])[0]
                            print(f"  ID —Å—Ç—Ä–∏–º–∞: {stream_id}")
                            print("üéâ –°–ï–†–í–ï–† –û–¢–ü–†–ê–í–õ–Ø–ï–¢ –°–û–û–ë–©–ï–ù–ò–Ø!")
                            return True
                    return True
            else:
                # –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∂–¥–∞—Ç—å
                pass
                
        print("‚úó –¢–∞–π–º–∞—É—Ç - –æ—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω")
        return False
            
    except Exception as e:
        print(f"‚úó –û—à–∏–±–∫–∞: {e}")
        return False
    finally:
        sock.close()
        print("‚úì –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ")

def simple_test():
    """–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏"""
    print("\n=== –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç ===")
    
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        sock.connect(('localhost', 23231))
        
        # –í–∫–ª—é—á–∞–µ–º TCP_NODELAY
        sock.setsockopt(socket.IPPROTO_TCP, socket.TCP_NODELAY, 1)
        
        # –ë—ã—Å—Ç—Ä–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        udp_payload = struct.pack('!HHI8s', 2, 12345, 0x7F000001, b'\x00' * 8)
        sock.send(b'\x01' + udp_payload)
        sock.send(b'\x03')
        
        # –ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ —á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç
        response = sock.recv(1024)
        if response:
            print(f"‚úì –ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç! –î–ª–∏–Ω–∞: {len(response)} –±–∞–π—Ç")
            return True
        else:
            print("‚úó –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞")
            return False
            
    except socket.timeout:
        print("‚úó –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ–∂–∏–¥–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞")
        return False
    except Exception as e:
        print(f"‚úó –û—à–∏–±–∫–∞: {e}")
        return False
    finally:
        sock.close()

def analyze_problem():
    """–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–µ—Ä–≤—ã–º —Ç–µ—Å—Ç–æ–º"""
    print("\n=== –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã ===")
    print("–ü–æ—á–µ–º—É –ø–µ—Ä–≤—ã–π —Ç–µ—Å—Ç –Ω–µ –≤–∏–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:")
    print("1. –°–µ—Ä–≤–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è (–≤–∏–¥–Ω—ã –≤ –ª–æ–≥–∞—Ö)")
    print("2. –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç–≤–µ—Ç (send_stream_created)")
    print("3. –ù–æ –∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤–æ–≤—Ä–µ–º—è")
    print("\n–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
    print("‚úì TCP_NODELAY –æ—Ç–∫–ª—é—á–µ–Ω - –¥–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∏–∑—É—é—Ç—Å—è")
    print("‚úì –ù–µ–±–ª–æ–∫–∏—Ä—É—é—â–µ–µ —á—Ç–µ–Ω–∏–µ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Windows")  
    print("‚úì –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∞–µ—Ç—Å—è –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö")

if __name__ == "__main__":
    print("–¢–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π —Å–µ—Ä–≤–µ—Ä–æ–º")
    print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏\n")
    
    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º—É
    analyze_problem()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
    success1 = debug_test()
    success2 = simple_test()
    
    if success1 and success2:
        print("\nüéâ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!")
    elif success2:
        print("\n‚ö†Ô∏è  –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –¥–µ—Ç–∞–ª—å–Ω—ã–π —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏")
        print("   –°–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–æ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Ç–∞–π–º–∏–Ω–≥–∞–º–∏")
    else:
        print("\n‚ùå –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å —Å–µ—Ä–≤–µ—Ä–æ–º")